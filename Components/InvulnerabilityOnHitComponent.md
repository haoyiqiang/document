# InvulnerabilityOnHitComponent API å‚è€ƒ

## æ¦‚è¿°

`InvulnerabilityOnHitComponent` åœ¨å®ä½“çš„ [`DamageReceivingComponent`](DamageReceivingComponent.md) å—åˆ°ä¼¤å®³åæä¾›ä¸´æ—¶æ— æ•ŒçŠ¶æ€ã€‚è¯¥ç»„ä»¶é€‚ç”¨äºåŸºäº"ç”Ÿå‘½å€¼"çš„æˆ˜æ–—ç³»ç»Ÿï¼Œç©å®¶å¯ä»¥æ‰¿å—æœ‰é™æ¬¡æ•°çš„ç¦»æ•£æ”»å‡»ã€‚

**ç»§æ‰¿å…³ç³»ï¼š**
`Component` â†’ `InvulnerabilityOnHitComponent`

## ä¸»è¦ç‰¹æ€§

- ğŸ›¡ï¸ **å—å‡»æ— æ•Œ** - å—ä¼¤åæä¾›ä¸´æ—¶ä¼¤å®³å…ç–«
- â±ï¸ **å¯é…ç½®æ—¶é•¿** - è‡ªå®šä¹‰æ— æ•ŒæŒç»­æ—¶é—´
- ğŸ¬ **åŠ¨ç”»æ”¯æŒ** - é›†æˆAnimationPlayerè¿›è¡Œè§†è§‰æ•ˆæœ
- ğŸ”„ **è‡ªåŠ¨é‡ç½®** - æ— æ•Œç»“æŸåè‡ªåŠ¨æ¢å¤æ­£å¸¸çŠ¶æ€
- ğŸ¯ **æ™ºèƒ½è§¦å‘** - ä»…åœ¨å®é™…å—ä¼¤æ—¶æ¿€æ´»æ— æ•Œ

## è®¾è®¡ç†å¿µ

è¯¥ç»„ä»¶ä¸ä½¿ç”¨ `HealthComponent` å› ä¸ºï¼š
- `HealthComponent` å¯èƒ½å› æŒç»­ä¼¤å®³æºï¼ˆå¦‚ä¸­æ¯’ï¼‰è€Œå¤±å»ç”Ÿå‘½å€¼
- è¿™ç§"ä¸´æ—¶æ— æ•Œ"ä¸“ä¸ºæ¥è‡ªæ•Œäººçš„ä¸€æ¬¡æ€§ä¼¤å®³è®¾è®¡

## å¯¼å‡ºå±æ€§

### åŸºç¡€è®¾ç½®
```gdscript
@export var isEnabled: bool = true
```
æ§åˆ¶ç»„ä»¶æ˜¯å¦å¯ç”¨ã€‚

### åŠ¨ç”»è®¾ç½®
```gdscript
@export var animationPlayer: AnimationPlayer
```
ç”¨äºæ’­æ”¾è§†è§‰æ•ˆæœçš„åŠ¨ç”»æ’­æ”¾å™¨ã€‚å¦‚æœä¸º `null`ï¼Œå°†è‡ªåŠ¨æŸ¥æ‰¾å®ä½“çš„ç¬¬ä¸€ä¸ª `AnimationPlayer` å­èŠ‚ç‚¹ã€‚

```gdscript
@export var animationOnStart: StringName = &"invulnerabilityOnHit"
```
æ— æ•Œå¼€å§‹æ—¶æ’­æ”¾çš„åŠ¨ç”»åç§°ã€‚

```gdscript
@export var animationOnEnd: StringName = &"RESET"
```
æ— æ•Œç»“æŸæ—¶æ’­æ”¾çš„åŠ¨ç”»åç§°ã€‚

## ä¿¡å·

### didStartInvulnerability
```gdscript
signal didStartInvulnerability
```
æ— æ•ŒçŠ¶æ€å¼€å§‹æ—¶å‘å‡ºã€‚

### didEndInvulnerability
```gdscript
signal didEndInvulnerability
```
æ— æ•ŒçŠ¶æ€ç»“æŸæ—¶å‘å‡ºã€‚

## åªè¯»å±æ€§

### isActive
```gdscript
var isActive: bool
```
è¿”å›å½“å‰æ˜¯å¦å¤„äºæ— æ•ŒçŠ¶æ€ï¼ˆåŸºäºå®šæ—¶å™¨çŠ¶æ€ï¼‰ã€‚

## å­èŠ‚ç‚¹

### InvulnerabilityTimer
- **ç±»å‹ï¼š** `Timer`
- **ç”¨é€”ï¼š** æ§åˆ¶æ— æ•ŒæŒç»­æ—¶é—´
- **é…ç½®ï¼š** åœ¨åœºæ™¯ä¸­è®¾ç½® `wait_time` å±æ€§

## ä¸»è¦æ–¹æ³•

### startInvulnerability()
```gdscript
func startInvulnerability() -> void
```
å¼€å§‹æ— æ•ŒçŠ¶æ€ï¼š
- å¯åŠ¨å®šæ—¶å™¨
- ç¦ç”¨ä¼¤å®³æ¥æ”¶ç»„ä»¶
- é‡ç½®ç´¯ç§¯åˆ†æ•°ä¼¤å®³
- åº”ç”¨è§†è§‰æ•ˆæœ
- å‘å‡ºä¿¡å·

### endInvulnerability()
```gdscript
func endInvulnerability() -> void
```
ç»“æŸæ— æ•ŒçŠ¶æ€ï¼š
- åœæ­¢å®šæ—¶å™¨
- é‡æ–°å¯ç”¨ä¼¤å®³æ¥æ”¶ç»„ä»¶
- é‡ç½®å®ä½“é¢œè‰²
- ç§»é™¤è§†è§‰æ•ˆæœ
- å‘å‡ºä¿¡å·

## ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬è®¾ç½®
```gdscript
# åœ¨ç©å®¶å®ä½“åœºæ™¯ä¸­
extends PlayerEntity

func _ready():
    # ç¡®ä¿æœ‰å¿…éœ€çš„ç»„ä»¶
    var invulnerability = $InvulnerabilityOnHitComponent
    var damageReceiving = $DamageReceivingComponent
    
    # è®¾ç½®æ— æ•Œæ—¶é•¿ï¼ˆåœ¨å®šæ—¶å™¨ä¸Šè®¾ç½®ï¼‰
    invulnerability.get_node("InvulnerabilityTimer").wait_time = 1.5
    
    # ç›‘å¬æ— æ•ŒçŠ¶æ€å˜åŒ–
    invulnerability.didStartInvulnerability.connect(_on_invulnerability_start)
    invulnerability.didEndInvulnerability.connect(_on_invulnerability_end)

func _on_invulnerability_start():
    # æ’­æ”¾æ— æ•ŒéŸ³æ•ˆ
    AudioManager.play_sound("invulnerable_start")
    
func _on_invulnerability_end():
    # æ’­æ”¾æ¢å¤éŸ³æ•ˆ
    AudioManager.play_sound("invulnerable_end")
```

### è§†è§‰æ•ˆæœé…ç½®
```gdscript
# åœ¨AnimationPlayerä¸­åˆ›å»º"invulnerabilityOnHit"åŠ¨ç”»
# ç¤ºä¾‹ï¼šé—ªçƒæ•ˆæœ
func setup_invulnerability_animation():
    var animation_player = $AnimationPlayer
    var animation = Animation.new()
    animation.length = 1.5  # ä¸å®šæ—¶å™¨æ—¶é•¿åŒ¹é…
    
    # æ·»åŠ modulateè½¨é“å®ç°é—ªçƒ
    var track_index = animation.add_track(Animation.TYPE_VALUE)
    animation.track_set_path(track_index, ".:modulate")
    
    # è®¾ç½®å…³é”®å¸§ï¼šé€æ˜ -> ä¸é€æ˜ -> é€æ˜...
    for i in range(6):  # é—ªçƒ3æ¬¡
        var time = i * 0.25
        var alpha = 0.3 if i % 2 == 0 else 1.0
        animation.track_insert_key(track_index, time, Color(1, 1, 1, alpha))
    
    animation_player.add_animation_library("invulnerability", animation)
```

### é«˜çº§ä¼¤å®³ç³»ç»Ÿé›†æˆ
```gdscript
# ä¸ç”Ÿå‘½å€¼ç³»ç»Ÿç»“åˆä½¿ç”¨
extends Entity

@onready var health_component = $HealthComponent
@onready var invulnerability_component = $InvulnerabilityOnHitComponent

func _ready():
    # ç›‘å¬ç”Ÿå‘½å€¼å˜åŒ–
    health_component.didLoseHealth.connect(_on_health_lost)
    invulnerability_component.didEndInvulnerability.connect(_on_vulnerability_restored)

func _on_health_lost(amount: int):
    # æ£€æŸ¥æ˜¯å¦æ­»äº¡
    if health_component.currentHealth <= 0:
        handle_death()
    else:
        # æ˜¾ç¤ºå—ä¼¤åé¦ˆï¼ˆå› ä¸ºæ— æ•ŒæœŸé—´çœ‹ä¸åˆ°ä¼¤å®³æ•°å­—ï¼‰
        show_damage_feedback(amount)

func _on_vulnerability_restored():
    # ç»™ç©å®¶ä¸€ä¸ªè§†è§‰æç¤ºè¡¨ç¤ºç°åœ¨å¯ä»¥å†æ¬¡å—ä¼¤
    flash_briefly(Color.WHITE)
```

### åŠ¨æ€æ— æ•Œæ—¶é•¿
```gdscript
# æ ¹æ®æ¸¸æˆçŠ¶æ€è°ƒæ•´æ— æ•Œæ—¶é•¿
extends InvulnerabilityOnHitComponent

func adjust_invulnerability_duration(difficulty_level: int):
    var base_duration = 1.5
    var duration_modifier = {
        1: 2.0,    # ç®€å•ï¼šæ›´é•¿æ— æ•Œæ—¶é—´
        2: 1.0,    # æ™®é€šï¼šæ­£å¸¸æ—¶é—´
        3: 0.7     # å›°éš¾ï¼šæ›´çŸ­æ—¶é—´
    }
    
    timer.wait_time = base_duration * duration_modifier.get(difficulty_level, 1.0)

func damageReceivingComponent_didReceiveDamage(damageComponent: DamageComponent, amount: int, attackerFactions: int):
    # è°ƒæ•´éš¾åº¦
    adjust_invulnerability_duration(GameState.difficulty_level)
    super.damageReceivingComponent_didReceiveDamage(damageComponent, amount, attackerFactions)
```

### ç‰¹æ®Šæ•ˆæœç³»ç»Ÿ
```gdscript
# åˆ›å»ºæ›´å¤æ‚çš„æ— æ•Œæ•ˆæœ
extends PlayerEntity

func _ready():
    var invul = $InvulnerabilityOnHitComponent
    invul.didStartInvulnerability.connect(_create_invul_effects)
    invul.didEndInvulnerability.connect(_remove_invul_effects)

func _create_invul_effects():
    # åˆ›å»ºæŠ¤ç›¾ç²’å­æ•ˆæœ
    var shield_particles = preload("res://Effects/ShieldParticles.tscn").instantiate()
    add_child(shield_particles)
    shield_particles.emitting = true
    
    # æ·»åŠ å‘å…‰æ•ˆæœ
    var glow_effect = preload("res://Effects/GlowOutline.gdshader")
    $Sprite2D.material = ShaderMaterial.new()
    $Sprite2D.material.shader = glow_effect
    
    # åˆ›å»ºéŸ³é¢‘å¾ªç¯
    $InvulnerabilitySound.play()

func _remove_invul_effects():
    # ç§»é™¤æ‰€æœ‰æ•ˆæœ
    for child in get_children():
        if child.name.begins_with("ShieldParticles"):
            child.queue_free()
    
    $Sprite2D.material = null
    $InvulnerabilitySound.stop()
```

## æŠ€æœ¯ç»†èŠ‚

### ç»„ä»¶ä¾èµ–
- **å¿…éœ€ï¼š** `DamageReceivingComponent`
- **å¯é€‰ï¼š** `AnimationPlayer`ï¼ˆç”¨äºè§†è§‰æ•ˆæœï¼‰
- **æ¨èï¼š** `Timer`å­èŠ‚ç‚¹ï¼ˆè‡ªåŠ¨åŒ…å«ï¼‰

### æ€§èƒ½è€ƒè™‘
- æ— æ•ŒçŠ¶æ€ä¸‹å®Œå…¨ç¦ç”¨ä¼¤å®³æ¥æ”¶ï¼Œé¿å…ä¸å¿…è¦çš„è®¡ç®—
- ä»…åœ¨å®é™…å—ä¼¤æ—¶è§¦å‘æ— æ•Œï¼Œè€Œéæ¯æ¬¡ç¢°æ’
- è‡ªåŠ¨é‡ç½®ç´¯ç§¯åˆ†æ•°ä¼¤å®³ï¼Œé¿å…çŠ¶æ€ä¸ä¸€è‡´

### è®¾è®¡æ¨¡å¼
- **çŠ¶æ€æœºæ¨¡å¼ï¼š** æ˜ç¡®çš„æ— æ•Œ/æ˜“ä¼¤çŠ¶æ€åˆ‡æ¢
- **ä¿¡å·é©±åŠ¨ï¼š** å“åº”å¼çš„äº‹ä»¶å¤„ç†
- **ç»„ä»¶ç»„åˆï¼š** ä¸å…¶ä»–æˆ˜æ–—ç»„ä»¶æ— ç¼é›†æˆ

## æ³¨æ„äº‹é¡¹

âš ï¸ **é‡è¦é™åˆ¶ï¼š**
- æ— æ•ŒæœŸé—´æ‰€æœ‰ä¼¤å®³éƒ½è¢«å¿½ç•¥ï¼ŒåŒ…æ‹¬æŒç»­ä¼¤å®³
- éœ€è¦ç¡®ä¿åŠ¨ç”»æ—¶é•¿ä¸å®šæ—¶å™¨æ—¶é•¿åŒ¹é…
- æ— æ•ŒçŠ¶æ€ä¸ä¼šè‡ªåŠ¨ä¿å­˜/åŠ è½½

ğŸ’¡ **æœ€ä½³å®è·µï¼š**
- ä¸ºä¸åŒç±»å‹çš„ä¼¤å®³æºè®¾ç½®ä¸åŒçš„æ— æ•Œæ—¶é•¿
- æä¾›æ¸…æ™°çš„è§†è§‰åé¦ˆè¡¨ç¤ºæ— æ•ŒçŠ¶æ€
- è€ƒè™‘åœ¨æ— æ•Œç»“æŸæ—¶ç»™å‡ºæç¤ºéŸ³æ•ˆ

ğŸ”® **è®¡åˆ’æ”¹è¿›ï¼š**
- æ”¯æŒéƒ¨åˆ†ä¼¤å®³å‡å…è€Œéå®Œå…¨å…ç–«
- å¯é…ç½®çš„è§†è§‰æ•ˆæœæ¨¡æ¿
- ä¸çŠ¶æ€æœºç³»ç»Ÿçš„æ›´å¥½é›†æˆ

## ç›¸å…³ç»„ä»¶

- [`DamageReceivingComponent`](DamageReceivingComponent.md) - å¿…éœ€ä¾èµ–ï¼Œæä¾›ä¼¤å®³æ¥æ”¶åŠŸèƒ½
- [`HealthComponent`](HealthComponent.md) - å¸¸ç”¨æ­é…ï¼Œç®¡ç†ç”Ÿå‘½å€¼
- [`DamageVisualComponent`](../Visual/DamageVisualComponent.md) - è§†è§‰æ•ˆæœç»„ä»¶
- [`KnockbackOnHitComponent`](KnockbackOnHitComponent.md) - å¯ç»„åˆçš„å—å‡»æ•ˆæœ

## æ•…éšœæ’é™¤

**é—®é¢˜ï¼šæ— æ•ŒçŠ¶æ€æ²¡æœ‰è§¦å‘**
- æ£€æŸ¥ `DamageReceivingComponent` æ˜¯å¦æ­£ç¡®é…ç½®
- ç¡®è®¤ `isEnabled` ä¸º true
- éªŒè¯å®é™…é€ æˆäº†ä¼¤å®³ï¼ˆamount > 0ï¼‰

**é—®é¢˜ï¼šè§†è§‰æ•ˆæœä¸æ’­æ”¾**
- æ£€æŸ¥ `AnimationPlayer` å¼•ç”¨æ˜¯å¦æ­£ç¡®
- ç¡®è®¤åŠ¨ç”»åç§°æ‹¼å†™æ­£ç¡®
- éªŒè¯åŠ¨ç”»æ˜¯å¦å­˜åœ¨äº AnimationPlayer ä¸­

**é—®é¢˜ï¼šæ— æ•Œæ—¶é—´ä¸æ­£ç¡®**
- æ£€æŸ¥ Timer å­èŠ‚ç‚¹çš„ `wait_time` è®¾ç½®
- ç¡®è®¤å®šæ—¶å™¨æ²¡æœ‰è¢«å…¶ä»–ç»„ä»¶å¹²æ‰° 